<!DOCTYPE html>
<head>
  <title>Peerdocs.org</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="dist/editor.js"></script>
  <script src="http://cdn.peerjs.com/0.3/peer.js"></script>
  <style>
    html {
      font-size: 20px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    }

    body {
      margin: 0;
    }

    * {
      box-sizing: border-box;
    }

    .emoji {
      height: 17px;
    }
  </style>
</head>
<body>
  <script>
var app = Elm.Editor.fullscreen({
  location: window.location.origin + window.location.pathname,
  peer: window.location.hash.length > 0 
    ? window.location.hash.slice(1) 
    : ''
})
var ports = app.ports
var peer

var conns = {}

function initPeer(options) {
  if (!peer) {
    peer = new Peer(options.id, {key: options.key})

    peer.on('connection', function(conn) {
      console.log('connection', conn)
      conn.on('data', function(data) {
        console.log('received', data)
        ports.subscribe.send(data)
      })
    })
  }
}

var cbBuffer = []
function initConn(id, cb) {
  var newConn

  if (conns[id] === 'connecting') { // connection being made
    cbBuffer.push([id, cb])
  } else if (conns[id] && conns[id].type === 'data') { // connection available
    cb(conns[id])()
  } else { // no connection available yet
    cbBuffer.push([id, cb])
    newConn = peer.connect(id)
    conns[id] = 'connecting'
    newConn.on('open', function() {
      conns[id] = newConn
      cbBuffer.filter(function([id, cb]) {
        if (conns[id] && conns[id].type === 'data') {
          cb(conns[id])()
          return false
        } else {
          return true
        }
      })
    })
  }
}

function makeSend(options) {
  return function(conn) {
    return function () {
      console.log('sending', options.payload)
      conn.send(options.payload)
    }
  }
}

ports.init.subscribe(initPeer)

ports.send.subscribe(function(options) {
  console.log('sent from Elm', options)
  initPeer({id: options.id, key: options.key})
  initConn(options.peerId, makeSend(options))
})

  </script>
</body>
